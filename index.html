<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Beat WOW - K-pop Warrior Rhythm Game v2.0</title>
    
    <!-- Google Analytics 4 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-633RQLC6T0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-633RQLC6T0');
        
        window.trackEvent = function(eventName, parameters = {}) {
            gtag('event', eventName, {
                event_category: 'game_interaction',
                ...parameters
            });
        };
        
        window.trackDonationClick = function(amount = 'custom') {
            gtag('event', 'donation_click', {
                source: 'neon_beat_wow',
                amount: amount,
                value: parseFloat(amount) || 1
            });
        };
    </script>
    
    <!-- MONETAG VERIFICATION -->
    <meta name="monetag" content="8ef262307a776405fd775446ef913087">

    
    <!-- Tone.js para notas limpias en tiempo real -->
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    
    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4837743291717475"
         crossorigin="anonymous"></script>
    <!-- Consent Mode v2 + Banner -->
    <script defer src="/consent.js"></script>
    <!-- Leaderboard System -->
    <script src="/leaderboard-global.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(145deg, #0a0a0a, #1a1a2e); color: white; overflow: hidden; height: 100vh; user-select: none; }
        .game-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; background: rgba(0,0,0,0.8); border-bottom: 2px solid #FF0080; }
        .score { color: #FFFF00; font-weight: bold; font-size: 18px; }
        .lives { color: #FF4444; font-weight: bold; font-size: 18px; }
        .combo { color: #00FFFF; font-weight: bold; font-size: 18px; }
        .game-area { width: 100%; height: calc(100vh - 80px); position: relative; display: flex; background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%); }
        .lane { width: 25%; height: 100%; border-left: 1px solid #00FFFF; position: relative; cursor: pointer; }
        .lane:last-child { border-right: 1px solid #00FFFF; }
        .hit-line { position: absolute; bottom: 80px; left: 0; right: 0; height: 6px; background: linear-gradient(90deg, #FF0080, #00FFFF, #FFFF00, #FF0080); box-shadow: 0 0 20px #FF0080; z-index: 10; }
        .note { position: absolute; width: 20%; height: 40px; left: 2.5%; background: linear-gradient(45deg, #FF0080, #00FFFF); border-radius: 8px; box-shadow: 0 0 15px #FF0080; border: 2px solid #FFFFFF; z-index: 5; }
        .touch-zone { position: absolute; bottom: 0; width: 100%; height: 160px; background: rgba(0,255,255,0.1); z-index: 20; }

        /* EFECTOS VISUALES √âPICOS */
        .hit-blast {
            position: absolute; width: 100px; height: 100px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,0,128,0.6) 50%, transparent 100%);
            pointer-events: none; z-index: 30; animation: hitBlast 0.3s ease-out forwards;
        }
        @keyframes hitBlast {
            0% { transform: scale(0) rotate(0deg); opacity: 1; }
            100% { transform: scale(3) rotate(360deg); opacity: 0; }
        }
        .particle {
            position: absolute; width: 8px; height: 8px; background: #FFFF00; border-radius: 50%;
            pointer-events: none; z-index: 25;
        }
        .combo-text {
            position: absolute; font-size: 24px; font-weight: bold; pointer-events: none; z-index: 35;
            animation: comboFloat 1s ease-out forwards;
        }
        @keyframes comboFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }
        .perfect-indicator {
            position: absolute; font-size: 20px; font-weight: bold; color: #FFFF00;
            text-shadow: 0 0 10px #FFFF00; pointer-events: none; z-index: 35;
            animation: perfectPulse 0.5s ease-out forwards;
        }
        @keyframes perfectPulse {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        .screen-shake { animation: shake 0.3s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .lane-flash { animation: laneFlash 0.2s ease-out; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes laneFlash {
            0% { background: rgba(255,255,255,0); }
            50% { background: rgba(255,255,255,0.4); }
            100% { background: rgba(255,255,255,0); }
        }
        
        /* ===== ANIMACIONES K-POP √âPICAS ===== */
        @keyframes kpopHeart {
            0% { transform: translateY(0) scale(0) rotate(0deg); opacity: 1; }
            50% { transform: translateY(-50px) scale(1.2) rotate(180deg); opacity: 1; }
            100% { transform: translateY(-100px) scale(0.5) rotate(360deg); opacity: 0; }
        }
        
        @keyframes kpopStar {
            0% { transform: translateY(0) scale(0) rotate(0deg); opacity: 1; }
            30% { transform: translateY(-30px) scale(1.5) rotate(120deg); opacity: 1; }
            100% { transform: translateY(-80px) scale(0.3) rotate(360deg); opacity: 0; }
        }
        
        @keyframes kpopRay {
            0% { transform: rotate(var(--rotation)) scale(0); opacity: 1; }
            50% { transform: rotate(var(--rotation)) scale(1.2); opacity: 0.8; }
            100% { transform: rotate(var(--rotation)) scale(2) translateY(-100px); opacity: 0; }
        }
        
        @keyframes kpopWave {
            0% { transform: translate(-50%, 50%) scale(0); opacity: 1; }
            50% { transform: translate(-50%, 50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, 50%) scale(3); opacity: 0; }
        }
        
        @keyframes kpopLaneFlash {
            0% { background: rgba(255,0,128,0); box-shadow: none; }
            25% { background: rgba(255,0,128,0.3); box-shadow: 0 0 20px #FF0080; }
            50% { background: rgba(0,255,255,0.3); box-shadow: 0 0 30px #00FFFF; }
            75% { background: rgba(255,255,0,0.3); box-shadow: 0 0 20px #FFFF00; }
            100% { background: rgba(255,0,128,0); box-shadow: none; }
        }
        
        @keyframes kpopRain {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }
        
        @keyframes kpopConfetti {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            50% { transform: translateY(-50px) rotate(180deg) scale(1.2); opacity: 0.8; }
            100% { transform: translateY(-100px) rotate(360deg) scale(0.5); opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Ads: ocultos durante el juego; visibles en game over -->
    <div id="top-banner" style="position:fixed;top:0;left:0;width:100%;height:50px;background:rgba(0,0,0,0.9);z-index:9998;display:none;align-items:center;justify-content:center;border-bottom:2px solid #00FFFF;">
        <ins class="adsbygoogle" style="display:block;width:320px;height:50px;"
             data-ad-client="ca-pub-4129506161314540" data-ad-slot="6673201053"></ins>
    </div>
    <div id="bottom-banner" style="position:fixed;bottom:0;left:0;width:100%;height:50px;background:rgba(0,0,0,0.9);z-index:9998;display:none;align-items:center;justify-content:center;border-top:2px solid #00FFFF;">
        <ins class="adsbygoogle" style="display:block;width:320px;height:50px;"
             data-ad-client="ca-pub-4129506161314540" data-ad-slot="6673201053"></ins>
    </div>
    
    <!-- Banner lateral para m√≥viles (m√°s agresivo) -->
    <div id="side-banner" style="position:fixed; right:10px; top:50%; transform:translateY(-50%); width:120px; height:600px; background:rgba(0,0,0,0.8); border:1px solid #00FFFF; border-radius:8px; display:none; z-index:1000;">
        <ins class="adsbygoogle" 
             style="display:block;width:120px;height:600px;" 
             data-ad-client="ca-pub-4129506161314540" 
             data-ad-slot="6673201053"></ins>
    </div>
    <div class="game-header">
        <div class="score" id="score">SCORE: 0</div>
        <div class="lives" id="lives">‚ù§Ô∏è 3</div>
        <div class="combo" id="combo">COMBO: 0</div>
        <div class="combo" id="speed" style="color:#00FF00">SPEED: 1.0x</div>
        <div class="combo" style="color:#FF0080">K-POP WARRIOR</div>
        <div id="audioControls" style="display:flex; gap:8px; align-items:center;">
            <span style="background:#333;color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:900;">üîä AUDIO</span>
            <select id="audioMode" style="background:#111;color:#fff;border:1px solid #00FFFF;border-radius:8px;padding:6px 10px;">
                <option value="only_hits" selected>Only Hits</option>
                <option value="silent">Silent</option>
            </select>
        </div>
    </div>
    
    <!-- Banner en header del juego -->
    <div id="menu-banner" style="margin: 10px 0; padding: 10px; background: rgba(0,0,0,0.8); border: 1px solid #00FFFF; border-radius: 8px; text-align: center;">
        <ins class="adsbygoogle" 
             style="display:block;width:320px;height:50px;" 
             data-ad-client="ca-pub-4129506161314540" 
             data-ad-slot="6673201053"></ins>
    </div>
    <div class="game-area" id="gameArea">
        <div class="lane" data-lane="0"><div class="touch-zone" data-lane="0"></div></div>
        <div class="lane" data-lane="1"><div class="touch-zone" data-lane="1"></div></div>
        <div class="lane" data-lane="2"><div class="touch-zone" data-lane="2"></div></div>
        <div class="lane" data-lane="3"><div class="touch-zone" data-lane="3"></div></div>
        <div class="hit-line"></div>
    </div>
    <script>
        let gameState = { 
            score: 0, combo: 0, maxCombo: 0, lives: 3, notes: [], gameActive: true, 
            frameCount: 0, perfectHits: 0, goodHits: 0, 
            speed: 1.0, // Velocidad base
            speedMultiplier: 1.0, // Multiplicador de velocidad
            gameStartTime: 0, // Tiempo de inicio del juego
            lastHitTime: 0, // Para crear ritmo
            rhythmPattern: [] // Patr√≥n de ritmo K-pop
        };
        // Audio Engine (Web Audio nativo) - SOLO notas en hit, sin fondo
        const audioEngine = {
            initialized: false,
            mode: 'only_hits', // 'silent' | 'only_hits'
            ctx: null,
            masterGain: null,
            // Frecuencias por lane: A4, C5, E5, G5
            freqByLane: [440.0, 523.25, 659.25, 783.99],
            async init() {
                if (this.initialized) return;
                try {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = 0; // mudo por defecto
                    this.masterGain.connect(this.ctx.destination);
                    this.initialized = true;
                    console.log('üîä WebAudio inicializado (solo hits)');
                } catch(e) {
                    console.warn('Audio init error', e);
                }
            },
            async ensureStarted() {
                if (!this.initialized) await this.init();
                if (this.ctx && this.ctx.state !== 'running') await this.ctx.resume();
            },
            setMode(newMode) {
                this.mode = newMode;
                if (newMode === 'silent') {
                    if (this.masterGain) this.masterGain.gain.value = 0;
                    if (this.ctx && this.ctx.state === 'running') this.ctx.suspend();
                }
            },
            async playLane(lane) {
                if (this.mode === 'silent') return;
                await this.ensureStarted();
                const f = this.freqByLane[lane % this.freqByLane.length];
                const osc = this.ctx.createOscillator();
                const env = this.ctx.createGain();
                osc.type = 'sine';
                osc.frequency.value = f;
                env.gain.setValueAtTime(0, this.ctx.currentTime);
                env.gain.linearRampToValueAtTime(0.9, this.ctx.currentTime + 0.005);
                env.gain.linearRampToValueAtTime(0.0, this.ctx.currentTime + 0.12);
                osc.connect(env);
                env.connect(this.masterGain);
                this.masterGain.gain.setValueAtTime(1.0, this.ctx.currentTime);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.14);
                // Suspender el contexto poco despu√©s para asegurar silencio total
                setTimeout(() => { if (this.mode !== 'silent' && this.ctx) { this.masterGain.gain.value = 0; this.ctx.suspend(); } }, 180);
            }
        };

        // Funci√≥n eliminada - ahora solo usamos el MusicEngine        
        function startGame() {
            console.log('üéÆ STARTING NEON BEAT WOW');
            
            // Track game start
            gtag('event', 'game_start', { game_name: 'neon_beat_wow' });
            
            gameState.gameActive = true;
            gameState.frameCount = 0;
            gameState.speed = 1.0;
            gameState.speedMultiplier = 1.0;
            gameState.gameStartTime = Date.now();
            
            // Reset banner strategy
            bannerShown = false;
            gameStartTime = Date.now();
            
            updateUI();
            gameLoop();
            setupControls();
            // SIN AUDIO - JUEGO COMPLETAMENTE SILENCIOSO
            hideAds();
            console.log('‚úÖ Game started successfully');
        }
        
        function gameLoop() {
            if (!gameState.gameActive) return;
            gameState.frameCount++;
            
            // Actualizar velocidad cada 10 segundos (600 frames a 60fps)
            const currentTime = Date.now();
            const elapsedSeconds = (currentTime - gameState.gameStartTime) / 1000;
            const newSpeedLevel = Math.floor(elapsedSeconds / 10) + 1;
            gameState.speedMultiplier = 1.0 + (newSpeedLevel - 1) * 0.3; // +30% cada 10 segundos
            
            // Spawn de notas m√°s lento al inicio, m√°s r√°pido con el tiempo
            const baseSpawnRate = 60; // Frames entre notas (m√°s lento al inicio)
            const adjustedSpawnRate = Math.max(20, baseSpawnRate - (newSpeedLevel - 1) * 8);
            
            if (gameState.frameCount >= adjustedSpawnRate) {
                spawnNote();
                gameState.frameCount = 0;
            }
            moveNotes();
            
            // Verificar si mostrar banners despu√©s de 30s
            checkBannerDisplay();
            
            requestAnimationFrame(gameLoop);
        }
        
        function spawnNote() {
            const lane = Math.floor(Math.random() * 4);
            const gameArea = document.getElementById('gameArea');
            const note = document.createElement('div');
            note.className = 'note';
            note.style.left = (lane * 25 + 2.5) + '%';
            note.style.top = '0px';
            note.dataset.lane = lane;
            gameArea.appendChild(note);
            gameState.notes.push({ element: note, lane: lane, y: 0 });
            console.log(`üéµ Note spawned in lane ${lane}. Total notes: ${gameState.notes.length}`);
        }
        
        function moveNotes() {
            gameState.notes.forEach((note, index) => {
                // Velocidad de ca√≠da progresiva
                const baseSpeed = 3.0; // Velocidad base m√°s lenta
                const currentSpeed = baseSpeed * gameState.speedMultiplier;
                note.y += currentSpeed;
                note.element.style.top = note.y + 'px';
                if (note.y > window.innerHeight) {
                    note.element.remove();
                    gameState.notes.splice(index, 1);
                    gameState.lives--;
                    gameState.combo = 0;
                    updateUI();
                    if (gameState.lives <= 0) gameOver();
                }
            });
        }
        
        function handleInput(lane) {
            if (!gameState.gameActive) return;
            console.log(`üëÜ Input detected on lane ${lane}`);
            const hitLineY = window.innerHeight - 160;
            let hitNote = null;
            let bestDistance = Infinity;
            gameState.notes.forEach((note, index) => {
                if (note.lane === lane) {
                    const distance = Math.abs(note.y - hitLineY);
                    if (distance < 50 && distance < bestDistance) {
                        hitNote = { note, index };
                        bestDistance = distance;
                    }
                }
            });
            if (hitNote) {
                hitNote.note.element.remove();
                gameState.notes.splice(hitNote.index, 1);
                
                // Determinar tipo de hit
                const hitType = bestDistance < 20 ? "PERFECT" : "GOOD";
                // WOW: m√°s puntos
                const scoreAdd = hitType === "PERFECT" ? 200 : 120;
                
                gameState.score += scoreAdd;
                gameState.combo++;
                if (gameState.combo > gameState.maxCombo) gameState.maxCombo = gameState.combo;
                
                if (hitType === "PERFECT") {
                    gameState.perfectHits++;
                    showPerfectIndicator(lane);
                } else {
                    gameState.goodHits++;
                }
                
                console.log(`‚úÖ ${hitType}! Score: ${gameState.score}, Combo: ${gameState.combo}`);
                
                // Efectos visuales
                showHitEffect(lane);
                showComboText(lane, gameState.combo, hitType);
                
                // Screen shake en combos altos
                if (gameState.combo % 8 === 0 && gameState.combo > 0) {
                    document.body.classList.add("screen-shake");
                    setTimeout(() => document.body.classList.remove("screen-shake"), 300);
                }
                
                // AUDIO: nota limpia por lane (Only Hits / Backing+Hits)
                audioEngine.playLane(lane);
                // EFECTOS VISUALES K-POP √âPICOS
                console.log('üéµ Creando efectos K-pop para lane', lane, 'tipo', hitType, 'combo', gameState.combo);
                createKPopEffect(lane, hitType, gameState.combo);
            } else {
                gameState.combo = 0;
                console.log(`‚ùå MISS on lane ${lane}`);
            }
            
            updateUI();
        }
        
        function showHitEffect(lane) {
            const laneElement = document.querySelector(`[data-lane="${lane}"]`);
            
            // Flash de la lane
            laneElement.classList.add("lane-flash");
            setTimeout(() => laneElement.classList.remove("lane-flash"), 200);
            
            // Hit blast circular
            const blast = document.createElement("div");
            blast.className = "hit-blast";
            blast.style.left = (lane * 25 + 12.5) + "%";
            blast.style.bottom = "80px";
            document.getElementById("gameArea").appendChild(blast);
            setTimeout(() => blast.remove(), 300);
            
            // Part√≠culas
            // WOW: m√°s part√≠culas
            for (let i = 0; i < 14; i++) {
                const particle = document.createElement("div");
                particle.className = "particle";
                particle.style.left = (lane * 25 + 12.5) + "%";
                particle.style.bottom = "80px";
                particle.style.background = ["#FF0080", "#00FFFF", "#FFFF00", "#FF6600"][Math.floor(Math.random() * 4)];
                document.getElementById("gameArea").appendChild(particle);
                
                const angle = (i * 45) * Math.PI / 180;
                const speed = 50 + Math.random() * 30;
                let x = 0, y = 0;
                const animateParticle = () => {
                    x += Math.cos(angle) * 2;
                    y += Math.sin(angle) * 2;
                    particle.style.transform = `translate(${x}px, ${-y}px)`;
                    particle.style.opacity = Math.max(0, 1 - Math.sqrt(x*x + y*y) / speed);
                    if (particle.style.opacity > 0) {
                        requestAnimationFrame(animateParticle);
                    } else {
                        particle.remove();
                    }
                };
                requestAnimationFrame(animateParticle);
            }
        }        
        function setupControls() {
            const touchZones = document.querySelectorAll('.touch-zone');
            touchZones.forEach((zone) => {
                const lane = parseInt(zone.dataset.lane);
                zone.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(lane); }, { passive: false });
                zone.addEventListener('click', (e) => { e.preventDefault(); handleInput(lane); });
            });
            console.log('‚úÖ Touch controls setup complete');
        }
        
        function updateUI() {
            document.getElementById("score").textContent = `SCORE: ${gameState.score}`;
            document.getElementById("lives").textContent = `‚ù§Ô∏è ${gameState.lives}`;
            
            const comboElement = document.getElementById("combo");
            comboElement.textContent = `COMBO: ${gameState.combo}`;
            
            // Actualizar indicador de velocidad
            const speedElement = document.getElementById("speed");
            speedElement.textContent = `SPEED: ${gameState.speedMultiplier.toFixed(1)}x`;
            
            // Color din√°mico del combo
            if (gameState.combo >= 50) {
                comboElement.style.color = "#FF0080";
                comboElement.style.textShadow = "0 0 10px #FF0080";
                comboElement.style.animation = "pulse 0.5s infinite";
            } else if (gameState.combo >= 30) {
                comboElement.style.color = "#FFFF00";
                comboElement.style.textShadow = "0 0 10px #FFFF00";
                comboElement.style.animation = "pulse 1s infinite";
            } else if (gameState.combo >= 15) {
                comboElement.style.color = "#00FFFF";
                comboElement.style.textShadow = "0 0 5px #00FFFF";
                comboElement.style.animation = "none";
            } else {
                comboElement.style.color = "#00FFFF";
                comboElement.style.textShadow = "none";
                comboElement.style.animation = "none";
            }
            
            // Color din√°mico de la velocidad
            if (gameState.speedMultiplier >= 2.0) {
                speedElement.style.color = "#FF0080";
                speedElement.style.textShadow = "0 0 10px #FF0080";
            } else if (gameState.speedMultiplier >= 1.5) {
                speedElement.style.color = "#FFFF00";
                speedElement.style.textShadow = "0 0 5px #FFFF00";
            } else {
                speedElement.style.color = "#00FF00";
                speedElement.style.textShadow = "none";
            }
        }        
        // CONTADOR DE PARTIDAS PARA ESTRATEGIA INTELIGENTE
        let gamesPlayed = 0;
        let lastInterstitialTime = 0;
        
        // ===== LEADERBOARD FUNCTIONS =====
        let leaderboard;
        
        function showLeaderboard(gameId) {
            if (window.showLeaderboard && typeof window.showLeaderboard === 'function') {
                window.showLeaderboard(gameId || 'neon-beat-wow');
            }
        }
        
        function hideLeaderboard() {
            const modal = document.querySelector('[style*="position: fixed"]');
            if (modal) modal.remove();
        }
        
        function gameOver() {
            gameState.gameActive = false;
            console.log("üíÄ GAME OVER");
            // Sin m√∫sica de fondo que parar
            
            gamesPlayed++;
            const currentTime = Date.now();
            
            // Submit score to leaderboard
            if (leaderboard) {
                leaderboard.submitScore(gameState.score, Math.floor(gameState.score / 1000) + 1, gameState.combo);
            }
            
            // Track game over
            gtag('event', 'game_over', { 
                game_name: 'neon_beat_stage', 
                score: gameState.score,
                combo: gameState.combo,
                perfect_hits: gameState.perfectHits
            });
            
            // ESTRATEGIA INTELIGENTE DE MONETIZACI√ìN
            // 1. Siempre mostrar banners en game over (no invasivo)
            showAds();
            
            // 2. Interstitial solo cada 3 partidas perdidas Y cada 5 minutos m√≠nimo
            const timeSinceLastInterstitial = currentTime - lastInterstitialTime;
            const shouldShowInterstitial = (gamesPlayed % 3 === 0) && (timeSinceLastInterstitial > 300000); // 5 minutos
            
            if (shouldShowInterstitial) {
                showInterstitialAd();
                lastInterstitialTime = currentTime;
            }
            
            showViralGameOverScreen();
        }

        function showViralGameOverScreen() {
            const modal = document.createElement("div");
            modal.style.cssText = "position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000;";
            modal.innerHTML = `<div style="background: linear-gradient(145deg, #1a1a2e, #16213e); padding: 30px; border-radius: 20px; text-align: center; border: 3px solid #00FFFF; box-shadow: 0 0 30px #FF0080; max-width: 90%;"><h2 style="color: #FF0080; margin: 20px 0;">üéÆ GAME OVER! üéÆ</h2><div style="margin: 20px 0; color: white;"><p>üéØ Score: ${gameState.score}</p><p>üî• Max Combo: ${gameState.combo}</p><p>‚ú® Notes Hit: ${Math.floor(gameState.score / 100)}</p></div><button onclick="showLeaderboard('neon-beat-wow')" style="width:100%; margin:10px 0; padding:15px; background: linear-gradient(45deg, #FFD700, #FFA500); border:none; color:white; font-weight:bold; border-radius:10px; cursor:pointer; font-size:16px;">üèÜ RANKING</button><button onclick="shareNeonBeat()" style="width:100%; margin:10px 0; padding:15px; background: linear-gradient(45deg, #FF0080, #00FFFF); border:none; color:white; font-weight:bold; border-radius:10px; cursor:pointer; font-size:16px;">üì± SHARE SCORE</button><button onclick="copyNeonBeatMessage()" style="width:100%; margin:10px 0; padding:15px; background: linear-gradient(45deg, #FFFF00, #FF0080); border:none; color:white; font-weight:bold; border-radius:10px; cursor:pointer; font-size:16px;">üìã COPY MESSAGE</button><div style="margin: 20px 0;"><h3 style="color: #FFFF00; margin-bottom: 15px;">üíñ ¬°Apoya el desarrollo!</h3><div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;"><a href="https://paypal.me/lipastudios/0.50" target="_blank" onclick="trackDonationClick('0.50')" style="padding: 12px 20px; background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">‚òï 0,50‚Ç¨</a><a href="https://paypal.me/lipastudios/2.00" target="_blank" onclick="trackDonationClick('2.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #FF9800, #FFC107); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">üçï 2‚Ç¨</a><a href="https://paypal.me/lipastudios/5.00" target="_blank" onclick="trackDonationClick('5.00')" style="padding: 12px 20px; background: linear-gradient(45deg, #E91E63, #F06292); color: white; font-weight: bold; border-radius: 8px; text-decoration: none; font-size: 14px;">üéÆ 5‚Ç¨</a></div></div><button onclick="watchAdToContinue(event)" style="width:100%; margin:10px 0; padding:15px; background: linear-gradient(45deg, #FF6600, #FFFF00); border:none; color:white; font-weight:bold; border-radius:10px; cursor:pointer; font-size:16px;">üé¨ WATCH AD TO CONTINUE</button><button onclick="restartGame()" style="width:100%; margin:10px 0; padding:15px; background: linear-gradient(45deg, #8A2BE2, #00FFFF); border:none; color:white; font-weight:bold; border-radius:10px; cursor:pointer; font-size:16px;">üîÑ NEW GAME</button>
            
            <!-- Interstitial Ad Container -->
            <div id="gameOverAd" style="margin-top: 20px; padding: 10px; background: rgba(0,0,0,0.8); border: 1px solid #00FFFF; border-radius: 8px;">
                <ins class="adsbygoogle"
                     style="display:block"
                     data-ad-client="ca-pub-4129506161314540"
                     data-ad-slot="6673201053"
                     data-ad-format="auto"></ins>
            </div></div>`;
            document.body.appendChild(modal);
        }

        function shareNeonBeat() {
            const shareText = `üéµ ¬°Consegu√≠ ${gameState.score} puntos en Neon Beat Stage! üéµ\n\nüî• Max Combo: ${gameState.combo}x\n‚ú® Notes Hit: ${Math.floor(gameState.score / 100)}\nüéÆ ¬øPuedes superarme?\n\nhttps://neon-beat-stage.netlify.app`;
            if (navigator.share) {
                navigator.share({ title: "Neon Beat Stage - K-pop Rhythm Game", text: shareText, url: "https://neon-beat-stage.netlify.app" });
            } else {
                copyNeonBeatMessage();
            }
        }

        function copyNeonBeatMessage() {
            const viralText = `üéµ ¬°Consegu√≠ ${gameState.score} puntos en Neon Beat Stage! üéµ\n\nüî• Max Combo: ${gameState.combo}x\n‚ú® Perfect Hits: ${Math.floor(gameState.score / 100)}\nüéÆ ¬øPuedes superarme?\n\nJuega aqu√≠: https://neon-beat-stage.netlify.app\n\n#NeonBeatStage #KpopRhythm #CyberpunkGame`;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(viralText).then(() => {
                    showNotification("üìã ¬°Mensaje copiado! P√©galo en tus redes sociales üöÄ");
                });
            } else {
                alert("üìã " + viralText);
            }
        }

        function watchAdToContinue(event) {
            const button = event.target;
            button.textContent = "‚è≥ LOADING AD...";
            button.disabled = true;
            setTimeout(() => {
                button.textContent = "üé¨ AD PLAYING...";
                setTimeout(() => {
                    gameState.lives = 2;
                    gameState.gameActive = true;
                    gameState.notes.forEach(note => {
                        if (note.element && note.element.parentNode) {
                            note.element.parentNode.removeChild(note.element);
                        }
                    });
                    gameState.notes = [];
                    gameState.frameCount = 0;
                    updateUI();
                    document.querySelector(`[style*="position: fixed"]`).remove();
                    showNotification("üé¨ AD REWARD: +2 LIVES! ‚ù§Ô∏è");
                    gameLoop();
                }, 3000);
            }, 1000);
        }

        function showPerfectIndicator(lane) {
            const indicator = document.createElement("div");
            indicator.className = "perfect-indicator";
            indicator.textContent = "PERFECT!";
            indicator.style.left = (lane * 25 + 12.5) + "%";
            indicator.style.bottom = "120px";
            document.getElementById("gameArea").appendChild(indicator);
            setTimeout(() => indicator.remove(), 500);
        }

        function showComboText(lane, combo, hitType) {
            if (combo < 2) return;
            
            const comboText = document.createElement("div");
            comboText.className = "combo-text";
            
            let color = "#FFFFFF";
            let emoji = "üéµ";
            if (combo >= 50) { color = "#FF0080"; emoji = "üî•"; }
            else if (combo >= 30) { color = "#FFFF00"; emoji = "‚ö°"; }
            else if (combo >= 15) { color = "#00FFFF"; emoji = "‚ú®"; }
            else if (combo >= 5) { color = "#FF6600"; emoji = "üéØ"; }
            
            comboText.style.color = color;
            comboText.style.textShadow = `0 0 10px ${color}`;
            comboText.textContent = `${emoji} ${combo}x COMBO!`;
            comboText.style.left = (lane * 25 + 12.5) + "%";
            comboText.style.bottom = "160px";
            
            document.getElementById("gameArea").appendChild(comboText);
            setTimeout(() => comboText.remove(), 1000);
        }
        function showNotification(message) {
            const notification = document.createElement("div");
            notification.style.cssText = "position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: linear-gradient(45deg, #FF0080, #00FFFF); color: white; padding: 15px 25px; border-radius: 25px; font-weight: bold; z-index: 10000; box-shadow: 0 0 20px #FF0080;";
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => { notification.remove(); }, 3000);
        }        
        // Add missing functions
        function restartGame() {
            gtag('event', 'game_restart', { game_name: 'neon_beat_wow' });
            location.reload();
        }
        
        function showInterstitialAd() {
            try {
                gtag('event', 'ad_impression', { game_name: 'neon_beat_wow' });
            } catch (e) {
                console.log('AdSense not loaded yet');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM loaded - Starting game...');
            
            // Track page view
            gtag('event', 'page_view', { game_name: 'neon_beat_wow' });
            
            // Initialize leaderboard
            setTimeout(() => {
                leaderboard = new GlobalLeaderboard('neon-beat-wow');
            }, 100);
            
            // Inicializar anuncios (no bloquea si no carga)
            hideAds();
            startGame();

            // Audio: iniciar tras primer interacci√≥n (requisito mobile)
            const prime = async () => { document.removeEventListener('click', prime); document.removeEventListener('touchstart', prime); await audioEngine.init(); };
            document.addEventListener('click', prime, { passive: true });
            document.addEventListener('touchstart', prime, { passive: true });

            // Control de modo de audio
            const modeSel = document.getElementById('audioMode');
            if (modeSel) {
                modeSel.addEventListener('change', (e) => {
                    audioEngine.setMode(e.target.value);
                    const modeLabel = e.target.value.replace('_',' ').toUpperCase();
                    showNotification(`üîä AUDIO: ${modeLabel}`);
                    gtag('event', 'audio_mode_change', { mode: e.target.value });
                });
                // Forzar Only Hits por defecto
                audioEngine.setMode(modeSel.value);
            }

            // Seguridad: si la pesta√±a pierde foco o se oculta, aseguramos silencio
            document.addEventListener('visibilitychange', () => {
                if (document.hidden && audioEngine.gain) {
                    audioEngine.gain.gain.rampTo(0, 0.02);
                }
            });
        });

        function showAds() {
            const top = document.getElementById('top-banner');
            const bottom = document.getElementById('bottom-banner');
            if (top) top.style.display = 'flex';
            if (bottom) bottom.style.display = 'flex';
        }
        // Ads helpers - ESTRATEGIA AGRESIVA PERO INTELIGENTE
        function showAds() {
            const top = document.getElementById('top-banner');
            const bottom = document.getElementById('bottom-banner');
            const side = document.getElementById('side-banner');
            const menu = document.getElementById('menu-banner');
            if (top) top.style.display = 'flex';
            if (bottom) bottom.style.display = 'flex';
            if (side) side.style.display = 'block';
            if (menu) menu.style.display = 'block';
        }
        
        function hideAds() {
            const top = document.getElementById('top-banner');
            const bottom = document.getElementById('bottom-banner');
            const side = document.getElementById('side-banner');
            const menu = document.getElementById('menu-banner');
            if (top) top.style.display = 'none';
            if (bottom) bottom.style.display = 'none';
            if (side) side.style.display = 'none';
            if (menu) menu.style.display = 'none';
        }
        
        // NUEVA ESTRATEGIA: Mostrar banners despu√©s de 30 segundos de juego
        let gameStartTime = 0;
        let bannerShown = false;
        
        function checkBannerDisplay() {
            // ESTRATEGIA INTELIGENTE - NO MOSTRAR BANNERS DURANTE EL JUEGO
            // Los banners solo se muestran en men√∫ y game over
            return;
        }
        
        // ESTRATEGIA INTELIGENTE - NO MOSTRAR BANNERS EN PAUSA
        function showPauseAds() {
            // Los banners solo se muestran en men√∫ y game over
            return;
        }

        // ===== EFECTOS VISUALES K-POP √âPICOS =====
        function createKPopEffect(lane, hitType, combo) {
            const gameArea = document.getElementById('gameArea');
            const laneElement = document.querySelector(`[data-lane="${lane}"]`);
            const hitLineY = window.innerHeight - 160;
            
            // 1. EXPLOSI√ìN DE CORAZONES K-POP
            if (hitType === "PERFECT") {
                for (let i = 0; i < 15; i++) {
                    const heart = document.createElement('div');
                    heart.innerHTML = 'üíñ';
                    heart.style.cssText = `
                        position: absolute;
                        font-size: 24px;
                        left: ${lane * 25 + 12.5}%;
                        bottom: ${hitLineY}px;
                        pointer-events: none;
                        z-index: 50;
                        animation: kpopHeart 1.5s ease-out forwards;
                    `;
                    gameArea.appendChild(heart);
                    setTimeout(() => heart.remove(), 1500);
                }
            }
            
            // 2. ESTRELLAS BRILLANTES
            for (let i = 0; i < 20; i++) {
                const star = document.createElement('div');
                star.innerHTML = '‚ú®';
                star.style.cssText = `
                    position: absolute;
                    font-size: ${16 + Math.random() * 12}px;
                    left: ${lane * 25 + 12.5 + (Math.random() - 0.5) * 20}%;
                    bottom: ${hitLineY + (Math.random() - 0.5) * 40}px;
                    pointer-events: none;
                    z-index: 45;
                    animation: kpopStar 2s ease-out forwards;
                `;
                gameArea.appendChild(star);
                setTimeout(() => star.remove(), 2000);
            }
            
            // 3. RAYOS DE ENERG√çA
            for (let i = 0; i < 8; i++) {
                const ray = document.createElement('div');
                ray.style.cssText = `
                    position: absolute;
                    width: 3px;
                    height: 60px;
                    background: linear-gradient(45deg, #FF0080, #00FFFF, #FFFF00);
                    left: ${lane * 25 + 12.5}%;
                    bottom: ${hitLineY}px;
                    pointer-events: none;
                    z-index: 40;
                    transform-origin: bottom center;
                    transform: rotate(${i * 45}deg);
                    animation: kpopRay 0.8s ease-out forwards;
                `;
                gameArea.appendChild(ray);
                setTimeout(() => ray.remove(), 800);
            }
            
            // 4. ONDAS DE CHOQUE
            for (let i = 0; i < 3; i++) {
                const wave = document.createElement('div');
                wave.style.cssText = `
                    position: absolute;
                    width: 100px;
                    height: 100px;
                    border: 3px solid #FF0080;
                    border-radius: 50%;
                    left: ${lane * 25 + 12.5}%;
                    bottom: ${hitLineY}px;
                    pointer-events: none;
                    z-index: 35;
                    transform: translate(-50%, 50%);
                    animation: kpopWave ${0.6 + i * 0.2}s ease-out forwards;
                `;
                gameArea.appendChild(wave);
                setTimeout(() => wave.remove(), 1000);
            }
            
            // 5. FLASH DE LANE ESTILO K-POP
            laneElement.style.animation = 'kpopLaneFlash 0.3s ease-out';
            setTimeout(() => {
                laneElement.style.animation = '';
            }, 300);
            
            // 6. EFECTOS ESPECIALES EN COMBOS ALTOS
            if (combo > 10) {
                createComboEffect(lane, combo);
            }
        }
        
        function createComboEffect(lane, combo) {
            const gameArea = document.getElementById('gameArea');
            const hitLineY = window.innerHeight - 160;
            
            // LLUVIA DE CORAZONES
            if (combo > 20) {
                for (let i = 0; i < 25; i++) {
                    const heart = document.createElement('div');
                    heart.innerHTML = 'üíï';
                    heart.style.cssText = `
                        position: absolute;
                        font-size: 20px;
                        left: ${Math.random() * 100}%;
                        top: -50px;
                        pointer-events: none;
                        z-index: 55;
                        animation: kpopRain 3s linear forwards;
                    `;
                    gameArea.appendChild(heart);
                    setTimeout(() => heart.remove(), 3000);
                }
            }
            
            // EXPLOSI√ìN DE CONFETTI
            if (combo > 30) {
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.innerHTML = ['üéâ', 'üéä', '‚ú®', 'üí´'][Math.floor(Math.random() * 4)];
                    confetti.style.cssText = `
                        position: absolute;
                        font-size: 16px;
                        left: ${lane * 25 + 12.5}%;
                        bottom: ${hitLineY}px;
                        pointer-events: none;
                        z-index: 60;
                        animation: kpopConfetti 2s ease-out forwards;
                    `;
                    gameArea.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 2000);
                }
            }
        }
    </script>
    
</body>
</html>
